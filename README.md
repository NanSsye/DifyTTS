# 🤖 Dify 插件 - 智能微信机器人助手

这是一个为 XYBot 开发的 Dify 插件，可以将微信与 Dify AI 平台无缝集成，提供智能对话和聊天室功能。
<img src="https://github.com/user-attachments/assets/a2627960-69d8-400d-903c-309dbeadf125" width="400" height="600">

## ✨ 功能特性

- 🔄 **多模型支持**：配置和切换多个不同的 AI 模型
- 💬 **智能聊天室**：群聊中的沉浸式聊天体验
- 🖼️ **图像识别**：支持发送图片并进行 AI 识别和分析
- 🎙️ **语音交互**：支持语音消息转文字和文字转语音
- 📊 **用户统计**：跟踪聊天数据，生成排行榜
- 🪙 **积分系统**：通过积分控制 API 使用量
- ⚡ **消息缓冲**：智能合并短时间内的多条消息，提高效率
- 🔊 **唤醒词功能**：通过特定词语唤醒指定 AI 模型

## 🛠️ 安装方法

1. 确保已安装 XYBot 框架
2. 将插件文件夹复制到`plugins/Dify/`目录下
3. 创建配置文件`plugins/Dify/config.toml`（见下方配置说明）
4. 重启 XYBot 服务

## ⚙️ 配置说明

在`plugins/Dify/config.toml`中进行配置：

```toml
[Dify]
enable = true                  # 是否启用插件
default-model = "default"      # 默认使用的模型
command-tip = true             # 是否显示命令提示
commands = ["ask", "问", "搜索"] # 触发命令列表
admin_ignore = true            # 管理员是否免积分
whitelist_ignore = true        # 白名单用户是否免积分
http-proxy = ""                # HTTP代理配置
voice_reply_all = false        # 是否总是使用语音回复
robot-names = ["小助手", "机器人"] # 机器人名称列表
remember_user_model = true     # 是否记住用户使用的模型
chatroom_enable = true         # 是否启用聊天室功能

# 模型配置
[Dify.models.default]
api-key = "你的DIFY_API_KEY"     # Dify API密钥
base-url = "https://api.dify.ai/v1" # Dify API基础URL
trigger-words = ["默认", "普通"]   # 模型触发词
wakeup-words = ["小助手", "助手"]  # 模型唤醒词
price = 1                       # 使用价格（积分）

# 可配置多个模型
[Dify.models.gpt4]
api-key = "另一个DIFY_API_KEY"
base-url = "https://api.dify.ai/v1"
trigger-words = ["GPT4", "高级"]
wakeup-words = ["小4", "专家"]
price = 5
```

## 🚀 使用指南

### 私聊模式

- 直接发送文本消息与机器人对话
- 发送语音消息，系统会转换为文字后处理
- 发送图片+文字，系统会分析图片内容

### 群聊模式

- 使用`@机器人名称 问题内容`与机器人对话
- 使用配置的触发命令，如`问 问题内容`
- 使用唤醒词，如`学姐，问题内容`直接唤醒特定模型
- 聊天室功能开启时，可以直接发消息交流

### 聊天室指令

| 指令       | 功能                 |
| ---------- | -------------------- |
| 退出聊天   | 离开当前聊天室       |
| 查看状态   | 显示聊天室当前状态   |
| 聊天室排行 | 显示聊天室参与者排行 |
| 我的统计   | 显示个人聊天数据     |
| 暂时离开   | 设置为离开状态       |
| 回来了     | 恢复活跃状态         |

### 模型切换与唤醒

- 临时使用其他模型：`[触发词]问题内容`
- 永久切换模型：`[触发词]切换`
- 通过唤醒词使用特定模型：`[唤醒词]问题内容`（不改变默认模型）

例如：

- `GPT4切换` - 永久切换到 GPT4 模型
- `学姐，今天天气怎么样？` - 临时使用"学姐"对应的模型回答问题
- `老夏，帮我查询股票` - 临时使用"老夏"对应的模型回答问题

## 🔍 常见问题

### 1️⃣ 图片无法识别

检查图片缓存功能是否正常，需确保在发送图片后立即发送文本或@机器人。

### 2️⃣ 积分不足

请联系管理员充值积分或申请加入白名单。

### 3️⃣ 语音转文字失败

可能是由于语音质量问题或服务器未正确配置 ffmpeg。

### 4️⃣ 唤醒词不起作用

检查配置文件中的唤醒词是否正确设置，并确保消息中包含完整的唤醒词。

## 📝 注意事项

- 图片识别功能仅支持最近发送的一张图片
- 语音消息目前仅支持私聊模式
- 为避免 API 滥用，设置了消息缓冲和积分机制
- 唤醒词区分大小写，请确保使用正确的格式

## 🔄 版本历史

- v1.3.2: 添加唤醒词功能，支持通过特定词语直接唤醒指定模型,修复群聊切换模型问题。
- v1.3.1: 修复群聊图片识别问题
- v1.2.1: 增加 Dify 自带语言转换识别功能。
  增加语音转文字/文本转语音 API 支持。
  增加图片上传识别功能，需要大模型支持。
  修复了一些 bug。 🐛 修复完毕！ ✅
- v1.1.0: 添加多模型支持
- v1.0.0: 初始版本发布

**给个 ⭐ Star 支持吧！** 😊

**开源不易，感谢打赏支持！**

![image](https://github.com/user-attachments/assets/2dde3b46-85a1-4f22-8a54-3928ef59b85f)

- 提交 Issue
- 联系插件作者

---

开发者：老夏的金库  
版本：1.3.2  
最后更新：2025 年 3 月 17 日
